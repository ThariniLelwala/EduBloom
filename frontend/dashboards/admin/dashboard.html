<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard</title>
    <script src="../../js/sidebar.js"></script>

    <!-- CSS -->
    <link rel="stylesheet" href="../../css/style.css" />
    <link rel="stylesheet" href="../../css/topbar.css" />
    <link rel="stylesheet" href="../../css/sidebar.css" />
    <link rel="stylesheet" href="../../css/cards.css" />
    <link rel="stylesheet" href="../../css/dashboard/progress.css" />
    <link rel="stylesheet" href="../../css/dashboard/task.css" />
    <link rel="stylesheet" href="../../css/admin/themes.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css"
      integrity="sha512-DxV+EoADOkOygM4IR9yXP8Sb2qwgidEmeqAEmDKIOfPRQZOWbXCzLC6vjbZyy0vPisbH2SyW27+ddLVCN+OMzQ=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
  </head>

  <body>
    <div class="bg-image"></div>

    <div class="container">
      <!-- Sidebar -->
      <div id="sidebar-container"></div>

      <!-- Main content -->
      <main id="content">
        <div class="card-grid">
          <!-- Welcome Card -->
          <div class="card welcome full">
            <div class="welcome-content">
              <h1 class="heading" id="welcome-heading">
                Welcome Administrator
              </h1>
              <div>
                "Manage the platform and ensure the best experience for all
                users."
              </div>
            </div>
            <div class="welcome-image"></div>
          </div>

          <!-- System Overview - Statistics Cards -->
          <div class="card w1 small-card">
            <h4>Total Users</h4>
            <p id="total-users">0</p>
          </div>

          <div class="card w1 small-card">
            <h4>Active Users</h4>
            <p id="active-users">0</p>
          </div>

          <div class="card w1 small-card">
            <h4>Total Forums</h4>
            <p id="total-forums">0</p>
          </div>

          <div class="card w1 small-card">
            <h4>Content Overview</h4>
            <div
              style="
                font-size: 12px;
                color: rgba(255, 255, 255, 0.8);
                margin-top: 8px;
              "
            >
              <div>
                Quizzes:
                <span id="total-quizzes" style="font-weight: bold">0</span>
              </div>
              <div>
                Notes: <span id="total-notes" style="font-weight: bold">0</span>
              </div>
            </div>
          </div>

          <!-- User Management Card -->
          <div class="card w1">
            <div class="card-title">
              <i class="fas fa-users"></i>
              <h3>User Management</h3>
            </div>
            <ul class="quick-actions">
              <li>
                <a href="user-management.html"> <i class="fas fa-user-plus"></i> Add New User </a>
              </li>
              <li>
                <a href="user-management.html"> <i class="fas fa-users-cog"></i> Manage Roles</a>
              </li>
              <li>
                <a href="user-management.html"> <i class="fas fa-ban"></i> Deactivate Users</a>
              </li>
            </ul>
          </div>

          <!-- Content Verification Card -->
          <div class="card w1">
            <div class="card-title">
              <i class="fas fa-file-check"></i>
              <h3>Verification</h3>
            </div>
            <ul class="quick-actions">
              <li>
                <a href="content-moderation.html">
                  <i class="fas fa-search"></i> Review Pending Content
                </a>
              </li>
              <li>
                <a href="forum-management.html">
                  <i class="fas fa-comments"></i> Review Pending Forums</a
                >
              </li>
              <li>
                <a href="user-management.html">
                  <i class="fas fa-check-circle"></i> Manage Verification Requests</a
                >
              </li>
            </ul>
          </div>

          <!-- Reports Card -->
          <div class="card w1">
            <div class="card-title">
              <i class="fas fa-file-alt"></i>
              <h3>Reports</h3>
            </div>
            <ul class="quick-actions">
              <li>
                <a href="help.html">
                  <i class="fas fa-clock"></i> Pending Reports
                </a>
              </li>
              <li>
                <a href="system-analytics.html">
                  <i class="fas fa-line-chart"></i> System Statistics</a
                >
              </li>
              <li>
                <a href="help.html">
                  <i class="fas fa-headset"></i> Help Desk Issues:
                  <span id="helpdesk-count">0</span></a
                >
              </li>
            </ul>
          </div>

          <!-- Today's Tasks Card -->
          <div class="card w1 h2">
            <div class="card-header">
              <h3>Admin Tasks</h3>
            </div>
            <ul id="dashboard-tasks-list"></ul>
            <button class="btn-secondary add-btn" id="dashboard-add-btn">
              + Add Task
            </button>
          </div>

          <!-- Recent Activity Card -->
          <div class="card w2">
            <div class="card-header">
              <h3>Recent Activity</h3>
            </div>
            <ul id="recent-activity-list" style="list-style: none; padding: 0; margin: 0;">
              <!-- Activity items will be populated here -->
            </ul>
            <button class="btn-secondary" style="margin-top: 12px;">View All Activity</button>
          </div>

          <!-- Pending Verifications Card -->
          <div class="card w1" id="pending-verifications">
            <h3>Pending Verifications</h3>
            <ul id="verifications-list"></ul>
            <button class="btn-secondary">View All</button>
          </div>
        </div>
      </main>
    </div>

    <!-- ===== Add/Edit/Delete Modals ===== -->
    <div id="task-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="modal-title">Add Task</h2>
          <button class="modal-close" id="modal-close">&times;</button>
        </div>
        <div class="modal-body">
          <input type="text" id="task-input" placeholder="Enter task..." />
        </div>
        <div class="modal-footer">
          <button class="btn-secondary" id="modal-cancel">Cancel</button>
          <button class="btn-primary" id="modal-save">Save</button>
        </div>
      </div>
    </div>

    <div id="edit-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Edit Task</h2>
          <button class="modal-close" id="edit-modal-close">&times;</button>
        </div>
        <div class="modal-body">
          <input type="text" id="edit-input" placeholder="Edit text..." />
          <input type="date" id="edit-date" />
        </div>
        <div class="modal-footer">
          <button class="btn-secondary" id="edit-cancel">Cancel</button>
          <button class="btn-primary" id="edit-save">Save</button>
        </div>
      </div>
    </div>

    <div id="delete-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Delete Task</h2>
          <button class="modal-close" id="delete-modal-close">&times;</button>
        </div>
        <div class="modal-body">
          <p>Are you sure you want to delete this task?</p>
        </div>
        <div class="modal-footer">
          <button class="btn-secondary" id="delete-cancel">Cancel</button>
          <button class="btn-primary" id="delete-confirm">Delete</button>
        </div>
      </div>
    </div>

    <!-- JS -->
    <script src="../../js/topbar.js"></script>
    <script src="../../js/bg-manager.js"></script>
    <script src="../../js/admin/admin-tasks.js"></script>
    <script src="../../js/admin/admin-stats.js"></script>
    <script src="../../js/admin/admin-dashboard.js"></script>
  </body>
</html>

      // Update welcome message with admin's name
      function updateWelcomeMessage() {
        const username = localStorage.getItem("username");
        const welcomeHeading = document.getElementById("welcome-heading");
        if (username) {
          welcomeHeading.textContent = `Welcome ${username}`;
        }
      }

      // Task management functions
      let currentType = "todo";
      let editContext = { type: null, index: null };
      let deleteContext = { type: null, index: null };

      async function loadDashboardTasks() {
        try {
          let tasks = JSON.parse(localStorage.getItem("adminTasks")) || {
            todo: [
              { task: "Review pending teacher verifications", done: false },
              { task: "Check system health and backups", done: true },
            ],
          };
          localStorage.setItem("adminTasks", JSON.stringify(tasks));
          renderDashboardTasks();
          bindDashboardEvents();
        } catch (err) {
          console.error("Error loading dashboard tasks:", err);
        }
      }

      function renderDashboardTasks() {
        const tasks =
          JSON.parse(localStorage.getItem("adminTasks"))?.todo || [];
        const list = document.getElementById("dashboard-tasks-list");
        if (!list) return;

        list.innerHTML = "";

        if (tasks.length === 0) {
          list.innerHTML = `<li>No pending tasks ðŸŽ‰</li>`;
          return;
        }

        tasks.forEach((task, index) => {
          const li = document.createElement("li");
          li.className = "task-item";
          if (task.done) li.classList.add("completed");

          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.className = "task-checkbox";
          checkbox.id = `dash-task-${index}`;
          checkbox.checked = !!task.done;

          const label = document.createElement("label");
          label.htmlFor = checkbox.id;
          label.textContent = task.task;

          checkbox.addEventListener("change", () => {
            task.done = checkbox.checked;
            li.classList.toggle("completed", checkbox.checked);
            saveTasks();
          });

          const actions = document.createElement("div");
          actions.className = "task-item-actions";

          const editBtn = document.createElement("i");
          editBtn.className = "fa fa-pencil";
          editBtn.title = "Edit";
          editBtn.addEventListener("click", () => openEditModal("todo", index));

          const deleteBtn = document.createElement("i");
          deleteBtn.className = "fa fa-trash";
          deleteBtn.title = "Delete";
          deleteBtn.addEventListener("click", () =>
            openDeleteModal("todo", index)
          );

          actions.appendChild(editBtn);
          actions.appendChild(deleteBtn);

          li.appendChild(checkbox);
          li.appendChild(label);
          li.appendChild(actions);
          list.appendChild(li);
        });
      }

      function saveTasks() {
        const tasks = JSON.parse(localStorage.getItem("adminTasks"));
        localStorage.setItem("adminTasks", JSON.stringify(tasks));
      }

      function bindDashboardEvents() {
        const modal = document.getElementById("task-modal");
        const modalClose = document.getElementById("modal-close");
        const modalCancel = document.getElementById("modal-cancel");
        const modalSave = document.getElementById("modal-save");
        const modalInput = document.getElementById("task-input");
        const modalTitle = document.getElementById("modal-title");

        const editModal = document.getElementById("edit-modal");
        const editInput = document.getElementById("edit-input");
        const editCancel = document.getElementById("edit-cancel");
        const editClose = document.getElementById("edit-modal-close");
        const editSave = document.getElementById("edit-save");

        const deleteModal = document.getElementById("delete-modal");
        const deleteConfirm = document.getElementById("delete-confirm");
        const deleteCancel = document.getElementById("delete-cancel");
        const deleteClose = document.getElementById("delete-modal-close");

        function openModal(m) {
          m.classList.add("show");
        }
        function closeModal(m) {
          m.classList.remove("show");
        }

        const addBtn = document.getElementById("dashboard-add-btn");
        if (addBtn) {
          addBtn.addEventListener("click", () => {
            currentType = "todo";
            modalTitle.textContent = "Add Task";
            modalInput.value = "";
            openModal(modal);
            modalInput.focus();
          });
        }

        [modalClose, modalCancel].forEach((btn) =>
          btn?.addEventListener("click", () => closeModal(modal))
        );

        modalSave.addEventListener("click", () => {
          const text = modalInput.value.trim();
          if (!text) return;

          let tasks = JSON.parse(localStorage.getItem("adminTasks")) || {
            todo: [],
          };
          tasks.todo.push({ task: text, done: false });
          localStorage.setItem("adminTasks", JSON.stringify(tasks));

          renderDashboardTasks();
          closeModal(modal);
        });

        [editCancel, editClose].forEach((btn) =>
          btn?.addEventListener("click", () => closeModal(editModal))
        );

        editSave.addEventListener("click", () => {
          if (!editContext) return;

          const { type, index } = editContext;
          const tasks = JSON.parse(localStorage.getItem("adminTasks"));
          const newText = editInput.value.trim();
          if (!newText) return;

          tasks[type][index].task = newText;
          localStorage.setItem("adminTasks", JSON.stringify(tasks));

          renderDashboardTasks();
          closeModal(editModal);
          editContext = { type: null, index: null };
        });

        [deleteCancel, deleteClose].forEach((btn) =>
          btn?.addEventListener("click", () => closeModal(deleteModal))
        );

        deleteConfirm.addEventListener("click", () => {
          const { type, index } = deleteContext;
          const tasks = JSON.parse(localStorage.getItem("adminTasks"));
          tasks[type].splice(index, 1);
          localStorage.setItem("adminTasks", JSON.stringify(tasks));
          renderDashboardTasks();
          closeModal(deleteModal);
        });
      }

      function openEditModal(type, index) {
        const editModal = document.getElementById("edit-modal");
        const editInput = document.getElementById("edit-input");
        editContext = { type, index };

        const tasks = JSON.parse(localStorage.getItem("adminTasks"));
        editInput.value = tasks[type][index].task;
        document.querySelector("#edit-modal .modal-header h2").textContent =
          "Edit Task";
        editModal.classList.add("show");
      }

      function openDeleteModal(type, index) {
        deleteContext = { type, index };
        const deleteModal = document.getElementById("delete-modal");
        deleteModal.classList.add("show");
      }

      // Load system overview statistics
      function loadSystemOverview() {
        // Total users
        const totalUsers = getTotalUsersCount();
        document.getElementById("total-users").textContent = totalUsers;

        // Active users
        const activeUsers = getActiveUsersCount();
        document.getElementById("active-users").textContent = activeUsers;

        // Total forums
        const totalForums = getTotalForumsCount();
        document.getElementById("total-forums").textContent = totalForums;

        // Total quizzes
        const totalQuizzes = getTotalQuizzesCount();
        document.getElementById("total-quizzes").textContent = totalQuizzes;

        // Total notes
        const totalNotes = getTotalNotesCount();
        document.getElementById("total-notes").textContent = totalNotes;
      }

      function getTotalUsersCount() {
        // Count users from localStorage or return simulated data
        const students = JSON.parse(localStorage.getItem("students")) || [];
        const teachers = JSON.parse(localStorage.getItem("teachers")) || [];
        const parents = JSON.parse(localStorage.getItem("parents")) || [];
        return students.length + teachers.length + parents.length || 45;
      }

      function getActiveUsersCount() {
        // Simulate active users
        return Math.floor(Math.random() * 20) + 8;
      }

      function getTotalForumsCount() {
        // Count forums from localStorage
        const forums = JSON.parse(localStorage.getItem("forums")) || [];
        return forums.length || 12;
      }

      function getTotalQuizzesCount() {
        // Count quizzes from localStorage
        const quizzes = JSON.parse(localStorage.getItem("quizzes")) || [];
        return quizzes.length || 28;
      }

      function getTotalNotesCount() {
        // Count notes from localStorage
        const notes = JSON.parse(localStorage.getItem("notes")) || [];
        return notes.length || 35;
      }

      // Load pending approvals
      function loadPendingApprovals() {
        const approvalsList = document.getElementById("approvals-list");
        if (!approvalsList) return;

        // Get pending verifications from backend or simulate
        const pendingItems = [
          {
            id: 1,
            teacher: "John Doe",
            type: "Certification",
            date: "2025-10-20",
          },
          {
            id: 2,
            teacher: "Sarah Smith",
            type: "Material Review",
            date: "2025-10-21",
          },
          {
            id: 3,
            teacher: "Mike Johnson",
            type: "Profile Verification",
            date: "2025-10-22",
          },
        ];

        approvalsList.innerHTML = "";

        if (pendingItems.length === 0) {
          approvalsList.innerHTML = `<li>No pending approvals</li>`;
          return;
        }

        pendingItems.slice(0, 3).forEach((item) => {
          const li = document.createElement("li");
          li.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
              <div>
                <div style="font-weight: 600;">${item.teacher}</div>
                <div style="font-size: 12px; color: rgba(255, 255, 255, 0.6);">${item.type}</div>
              </div>
              <div style="font-size: 12px; color: rgba(255, 255, 255, 0.6);">${item.date}</div>
            </div>
          `;
          approvalsList.appendChild(li);
        });
      }

      // Load helpdesk issue count
      function loadHelpdeskCount() {
        const helpdeskCount = getHelpdeskIssueCount();
        const countElement = document.getElementById("helpdesk-count");
        if (countElement) {
          countElement.textContent = helpdeskCount;
        }
      }

      function getHelpdeskIssueCount() {
        // Count help desk issues from localStorage
        const issues =
          JSON.parse(localStorage.getItem("helpdesk_issues")) || [];
        return issues.length || 5;
      }

      // Load recent activity
      function loadRecentActivity() {
        const activityList = document.getElementById("recent-activity-list");
        if (!activityList) return;

        // Get recent activities from backend or simulate
        const recentActivities = [
          {
            id: 1,
            user: "John Doe",
            action: "Created new quiz",
            timestamp: "2 hours ago",
            icon: "fas fa-plus-circle",
          },
          {
            id: 2,
            user: "Sarah Smith",
            action: "Uploaded course materials",
            timestamp: "4 hours ago",
            icon: "fas fa-upload",
          },
          {
            id: 3,
            user: "Mike Johnson",
            action: "Posted in forum",
            timestamp: "6 hours ago",
            icon: "fas fa-comments",
          },
          {
            id: 4,
            user: "Emily Brown",
            action: "Completed a quiz",
            timestamp: "8 hours ago",
            icon: "fas fa-check-circle",
          },
          {
            id: 5,
            user: "Alex Davis",
            action: "Submitted assignment",
            timestamp: "10 hours ago",
            icon: "fas fa-file-upload",
          },
        ];

        activityList.innerHTML = "";

        if (recentActivities.length === 0) {
          activityList.innerHTML = `<li style="padding: 16px 0; text-align: center; color: rgba(255, 255, 255, 0.6);">No recent activity</li>`;
          return;
        }

        recentActivities.forEach((activity) => {
          const li = document.createElement("li");
          li.innerHTML = `
            <div style="display: flex; align-items: center; gap: 12px; padding: 12px 0; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
              <i class="${activity.icon}" style="font-size: 18px; color: rgba(255, 255, 255, 0.7);"></i>
              <div style="flex: 1;">
                <div style="font-weight: 600; font-size: 14px;">${activity.user}</div>
                <div style="font-size: 12px; color: rgba(255, 255, 255, 0.6);">${activity.action}</div>
              </div>
              <div style="font-size: 11px; color: rgba(255, 255, 255, 0.5); text-align: right;">${activity.timestamp}</div>
            </div>
          `;
          activityList.appendChild(li);
        });
      }
    </script>

    <!-- Theme Manager -->
    <script src="../../js/admin/admin-theme-manager.js"></script>
  </body>
</html>
